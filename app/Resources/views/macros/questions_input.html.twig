{% macro questions_input(parent_form) %}
  {% set question_name = parent_form.questions.vars.full_name ~ "[__question_id__]" %}
  {% set answer_name = question_name ~ "[answers][__answer_id__]" %}

  <h1>Fragen:</h1>
  <div ng-app="instructionQuestions" ng-controller="questionsController">
    <ul class="questions">

    {# Angular starts here #}
    {% verbatim %}

      <div ng-repeat="question in questions track by question.index" class="question">
        <div class="form-group">

            <label
              class="sr-only"
              for="{{ question.imagePathFullPath }}"> Bild (optional)
            </label>

            <input
              type="text"
              class="question-input form-control mb-2 mr-sm-2 mb-sm-0"
              placeholder="Bild (optional)"
              id="{{ question.imagePathFullPath }}"
              name="{{ question.imagePathFullPath }}">

            <label
              class="sr-only"
              for="{{ question.questionTextFullPath }}">
              Frage
            </label>

            <input
              type="text"
              class="question-input form-control mb-2 mr-sm-2 mb-sm-0"
              placeholder="Wie lautet..."
              id="{{ question.questionTextFullPath }}"
              name="{{ question.questionTextFullPath }}">
          </div>

          <div ng-repeat="answer in question.answers track by answer.index" style="display: flex; flex-direction: row;">
            <div style="width: 75%;">

              <label
                class="sr-only"
                for="{{answer.answerTextFullPath}}"> Antwort
              </label>

              <input
                type="text"
                class="answer-input form-control mb-1 mr-sm-2 mb-sm-0"
                placeholder="Antwort {{ answer.index + 1 }}"
                id="{{ answer.answerTextFullPath }}"
                name="{{ answer.answerTextFullPath }}">
            </div>

            <div
              class="form-check mb-2 mr-sm-2 mb-sm-0"
              style="width: 20%;">
              <label
                class="form-check-label">
                <input
                  class="form-check-input"
                  type="checkbox"
                  name="{{ answer.isCorrectFullPath }}"> Korrekt
              </label>
            </div>

            <div>
              <a ng-if="question.answers.length > 2" ng-click="removeAnswer(question, answer)" class="btn btn-danger">
                <span class="fa fa-times action-icon"></span>
              </a>
            </div>
          </div>
          <a class="add-answer btn btn-success" ng-click="addAnswerTo(question)" id="add_answer_for___question_id__">+</a>
      </div>

    </ul>
    <a ng-click="addQuestion()" class="btn btn-primary mb-2" id="add-question">Frage hinzuf√ºgen</a>

    {% endverbatim %}
    {# Angular ends here #}

  </div>

  <script>

  angular.module('instructionQuestions', []).controller('questionsController', function($scope) {
    var QUESTION_FULL_PATH = "{{ question_name }}";
    var ANSWER_FULL_PATH = "{{ answer_name }}";
    var QUESTION_ID = "__question_id__";
    var ANSWER_ID = "__answer_id__";

    $scope.questions = [];

    $scope.addQuestion = function() {
      var index = $scope.questions.length;
      var newQuestion = {
        index:                index,
        questionTextFullPath: questionAttributePathWithIndex(index, 'questionText'),
        imagePathFullPath:    questionAttributePathWithIndex(index, 'imagePath'),
        answersFullPath:      questionAttributePathWithIndex(index, 'answers'),
        answers:              [],
      };

      $scope.addAnswerTo(newQuestion);
      $scope.addAnswerTo(newQuestion);

      $scope.questions.push(newQuestion);
    };

    $scope.addAnswerTo = function(question) {
      var questionIndex = question.index;
      var answerIndex = question.answers.length;

      var newAnswer = {
        index:              answerIndex,
        answerTextFullPath: answerAttributePathWithIndices(questionIndex, answerIndex, 'answerText'),
        isCorrectFullPath:  answerAttributePathWithIndices(questionIndex, answerIndex, 'isCorrect'),
      };

      question.answers.push(newAnswer);
    };

    $scope.removeAnswer = function(question, answer) {
      var removeIndex = question.answers.indexOf(answer);

      question.answers.splice(removeIndex, 1);
    }

    var questionAttributePathWithIndex = function(questionIndex, attributeName) {
      var regexToReplace = new RegExp(QUESTION_ID, 'g');
      var fullPath = QUESTION_FULL_PATH.replace(regexToReplace, questionIndex);
      return (fullPath + '[' + attributeName + ']');
    };


    var answerAttributePathWithIndices = function(questionIndex, answerIndex, attributeName) {
      var questionIdRegEx = new RegExp(QUESTION_ID, 'g');
      var answerIdRegEx = new RegExp(ANSWER_ID, 'g');
      var fullPath = ANSWER_FULL_PATH.replace(questionIdRegEx, questionIndex)
                                     .replace(answerIdRegEx, answerIndex);
      return (fullPath + '[' + attributeName + ']');
    };
    $scope.addQuestion();

  });

  </script>
{% endmacro %}
